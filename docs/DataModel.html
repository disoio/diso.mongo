<!DOCTYPE html>

<html>
<head>
  <title>DataModel.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="BaseModel.html">
                BaseModel.coffee
              </a>
            
              
              <a class="source" href="DataModel.html">
                DataModel.coffee
              </a>
            
              
              <a class="source" href="EmbeddedModel.html">
                EmbeddedModel.coffee
              </a>
            
              
              <a class="source" href="Model.html">
                Model.coffee
              </a>
            
              
              <a class="source" href="ReferenceModel.html">
                ReferenceModel.coffee
              </a>
            
              
              <a class="source" href="Schema.html">
                Schema.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="DataModelTest.html">
                DataModelTest.coffee
              </a>
            
              
              <a class="source" href="PersistenceTest.html">
                PersistenceTest.coffee
              </a>
            
              
              <a class="source" href="test.html">
                test.coffee
              </a>
            
              
              <a class="source" href="utils.html">
                utils.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>DataModel.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2 id="npm-dependencies">NPM dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><a href="https://github.com/stephenhandley/type-of-is">type-of-is</a><br><a href="https://github.com/mongodb/node-mongodb-native">mongodb</a><br><a href="https://github.com/caolan/async">async</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Type    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'type-of-is'</span>)
MongoDB = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>)
Async   = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="local-dependencies">Local dependencies</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><a href="./BaseModel.html">BaseModel</a><br><a href="./ReferenceModel.html">ReferenceModel</a><br><a href="./Schema.html">Schema</a><br><a href="./utils.html">utils</a>  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>BaseModel      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./BaseModel'</span>) 
ReferenceModel = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./ReferenceModel'</span>)
Schema         = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Schema'</span>)
utils          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="throwerror">throwError</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>convenience method for throwing errors in this class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">throwError</span> = <span class="hljs-params">(msg)</span>-&gt;</span>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">"diso.mongo.DataModel: <span class="hljs-subst">#{msg}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h1 id="datamodel">DataModel</h1>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This class is the base of the model hierarchy, taking
care of data access and schema enforcement / casting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseModel</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="constructor">constructor</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3 id="required-args">required args</h3>
<p><strong>data</strong> : the raw data being used to create this model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(data)</span>-&gt;</span>
    <span class="hljs-property">@_data</span> = <span class="hljs-property">@constructor</span>.cast(data)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="-schema-methods-"><em>SCHEMA METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h2 id="-schema">@schema</h2>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Called by child classes to define their schema. This
method gets passed an object defining the child class’
schema attributes. This is processed and the result is 
used for data casting and validation</p>
<h3 id="required-args">required args</h3>
<p><strong>schema</strong> : plain object defining schema attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@schema</span> : <span class="hljs-function"><span class="hljs-params">(schema)</span>-&gt;</span>
    <span class="hljs-property">@_schema</span> = <span class="hljs-keyword">new</span> Schema({
      schema  : schema
      model   : @
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>defines accessors for schema attributes as long as
those attributes don’t already exist.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> schema
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(k)</span>=&gt;</span>
        <span class="hljs-keyword">unless</span> k <span class="hljs-keyword">of</span> <span class="hljs-property">@prototype</span>
          Object.defineProperty(<span class="hljs-property">@prototype</span>, k, {
            <span class="hljs-attribute">get</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
              <span class="hljs-property">@_data</span>[k]

            <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(val)</span>-&gt;</span>
              <span class="hljs-property">@_dataPath</span>(k, val)
          })</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if the schema specifies an alias for the _id property, 
an associated property is defined using the alias </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    pschema = <span class="hljs-property">@_schema</span>.processed_schema
    <span class="hljs-property">@id_has_alias</span> = ((<span class="hljs-string">'_id'</span> <span class="hljs-keyword">of</span> pschema) <span class="hljs-keyword">and</span> pschema._id.alias)

    <span class="hljs-keyword">if</span> <span class="hljs-property">@id_has_alias</span>
      alias = pschema._id.alias

      <span class="hljs-keyword">if</span> alias <span class="hljs-keyword">of</span> <span class="hljs-property">@prototype</span>
        throwError(<span class="hljs-string">"Invalid alias: <span class="hljs-subst">#{alias}</span>, conflicts with exist property"</span>)
      
      Object.defineProperty(<span class="hljs-property">@prototype</span>, alias, {
        get : <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
          <span class="hljs-property">@_data</span>._id

        set : <span class="hljs-function"><span class="hljs-params">(val)</span>-&gt;</span>
          <span class="hljs-property">@_dataPath</span>(<span class="hljs-string">'_id'</span>, val)
      })

    <span class="hljs-property">@_schema</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="-cast">@cast</h2>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>This is called by the constructor to cast data using
this model’s schema. After handling _id aliasing, this
method delegates the cast to this model’s schema object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@cast</span>: <span class="hljs-function"><span class="hljs-params">(data)</span>-&gt;</span>    
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@_schema</span>
      throwError(<span class="hljs-string">"@schema has not been called for <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>if the id has an alias, we set _id from it and then 
delete the alias from the data so it isn’t duped</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-property">@id_has_alias</span>
      alias = <span class="hljs-property">@_schema</span>.processed_schema._id.alias
      
      <span class="hljs-keyword">if</span> (alias <span class="hljs-keyword">of</span> data)
        <span class="hljs-keyword">if</span> (<span class="hljs-string">'_id'</span> <span class="hljs-keyword">of</span> data)
          throwError(<span class="hljs-string">"Cannot pass _id and its alias, <span class="hljs-subst">#{alias}</span>, as data attributes"</span>)
        
        data._id = data[alias]
        <span class="hljs-keyword">delete</span> data[alias]

    <span class="hljs-property">@_schema</span>.cast(data)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="attributeexists">attributeExists</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>check whether this model’s schema defines an attribute 
with the given path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">attributeExists</span>: <span class="hljs-function"><span class="hljs-params">(path)</span>-&gt;</span>
    utils.splitPath(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="attributeschema">attributeSchema</h2>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Get the schema associate with this model’s attribute at
the given path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">attributeSchema</span>: <span class="hljs-function"><span class="hljs-params">(path)</span>-&gt;</span>
    <span class="hljs-property">@constructor</span>._schema.attribute(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="requireattribute">requireAttribute</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Throw an error if this model’s schema doesn’t define an 
attribute with the given name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">requireAttribute</span>: <span class="hljs-function"><span class="hljs-params">(attr)</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> <span class="hljs-property">@attributeExists</span>(attr)
      throwError(<span class="hljs-string">"Missing attribute: <span class="hljs-subst">#{attr}</span>"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="-data-access-methods-"><em>DATA ACCESS METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="data-">data </h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Convenience accessor for this model’s underlying data
that performs different set/get behaviors depending on 
the arity and type signature of its arguments</p>
<p>()               : return model and its embedded models’
                   underlying data as plain object</p>
<p>(<String>)       : read the attribute at the string path</p>
<p>(<Array>)        : read the attributes at each string 
                   in array</p>
<p>(<Object>)       : use each <String>,<val> pair of 
                   attribute path &amp; value in object to 
                   set this model’s data</p>
<p>(<String>,<val>) : set the attribute at the string path 
                   to val</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">data</span>: <span class="hljs-function"><span class="hljs-params">(args...)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Full read
calling with no arguments returns the complete, underlying data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (args.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-property">@_map</span>()

    <span class="hljs-keyword">if</span> (args.length <span class="hljs-keyword">is</span> <span class="hljs-number">1</span>)
      arg = args[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Attribute read
calling with single String argument returns that attribute’s value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">switch</span> Type(arg)
        <span class="hljs-keyword">when</span> String
          <span class="hljs-keyword">return</span> <span class="hljs-property">@_dataPath</span>(arg)</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Filtered read
with single Array argument, return a filtered version of the 
underlying data object with only the requested attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">when</span> Array
          result = {}
          <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> arg
            result[attr] = <span class="hljs-property">@_dataPath</span>(attr)
          <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>write</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">when</span> Object
          <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> arg
            <span class="hljs-property">@_dataPath</span>(k, v)
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>

    <span class="hljs-keyword">if</span> (args.length <span class="hljs-keyword">is</span> <span class="hljs-number">2</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Attribute write
treat two arguments as a write of the given attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>._dataPath(args[<span class="hljs-number">0</span>], args[<span class="hljs-number">1</span>])
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>

    throwError(<span class="hljs-string">"Invalid argument to .data"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="deflate">deflate</h2>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Called by server to create json object for transfer over
the wire</p>
<h3 id="required-args">required args</h3>
<p><strong>model_key</strong> : The attribute name used to hold the model’s 
                constructor name to be used by inflate</p>
<h3 id="optional-args">optional args</h3>
<p><strong>attrs</strong> : Only include the specified attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deflate : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> (<span class="hljs-string">'model_key'</span> <span class="hljs-keyword">of</span> args)
      throwError(<span class="hljs-string">"deflate call missing 'model_key' arg"</span>)

    <span class="hljs-property">@_map</span>(args)</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="set">set</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Convenience alias for .data(path, value)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(path, value)</span>-&gt;</span>
    <span class="hljs-property">@_dataPath</span>(path, value)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h2 id="get">get</h2>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Convenience alias for .data(path)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get</span>: <span class="hljs-function"><span class="hljs-params">(path)</span>-&gt;</span>
    <span class="hljs-property">@_dataPath</span>(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="-stub-methods-"><em>STUB METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h2 id="validate">validate</h2>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Child classes can override this method to perform model
validation. Should return error if validation fails, or
null if validation succeeded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">validate</span>: <span class="hljs-function"><span class="hljs-params">()</span>-&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2 id="-internal-methods-"><em>INTERNAL METHODS</em></h2>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h2 id="_map">_map</h2>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Traverses this model and its embedded models and reference
models to produce a plain object of its data.</p>
<p>This is called via .data() and .deflate(). The difference 
between the two are that data is primarily used before
persisting to the database, while deflate is called prior
to transfer over the wire to the client. In the latter case
the model name is added as an additional attribute for use
in inflation on the other side of the wire</p>
<h3 id="optional-args">optional args</h3>
<p><strong>model_key</strong> : If present, specifies the attribute name 
                used to hold this model’s constructor name</p>
<p><strong>attrs</strong>     : Only include the specified attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _map : <span class="hljs-function"><span class="hljs-params">(args)</span>-&gt;</span>
    args ?= {}
    
    model_key = <span class="hljs-keyword">if</span> (<span class="hljs-string">'model_key'</span> <span class="hljs-keyword">of</span> args)
      args.model_key
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">null</span>

    attrs = <span class="hljs-keyword">if</span> (<span class="hljs-string">'attrs'</span> <span class="hljs-keyword">of</span> args)
      args.attrs
    <span class="hljs-keyword">else</span>
      <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>atom function that gets mapped across the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">getData</span> = <span class="hljs-params">(v)</span>-&gt;</span>
      is_model     = Type.instance(v, BaseModel)
      is_reference = Type.instance(v, ReferenceModel)

      <span class="hljs-keyword">if</span> (is_model <span class="hljs-keyword">or</span> is_reference)
        v._map(
          attrs     : attrs
          model_key : model_key
        )
      <span class="hljs-keyword">else</span>
        v

    result = {}

    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> <span class="hljs-property">@_data</span>
      <span class="hljs-keyword">if</span> (!attrs <span class="hljs-keyword">or</span> (k <span class="hljs-keyword">in</span> attrs))
        result[k] = <span class="hljs-keyword">if</span> Type(v, Array)
          v.map(getData)
        <span class="hljs-keyword">else</span>
          getData(v)</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>add model key if arg present</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> model_key
      result[model_key] = <span class="hljs-property">@constructor</span>.name

    result</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <h2 id="_datapath">_dataPath</h2>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Get or set the value at path.</p>
<h3 id="required-args">required args</h3>
<p><strong>path</strong> : can be simple string or composite path
           consisting of . separated parts (in order 
           to access subdocs, arrays, embedded models</p>
<h3 id="optional-args">optional args</h3>
<p><strong>value</strong> : if value is specified, use it to set the
            attribute at path, otherwise return that
            attribute’s value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">_dataPath</span>: <span class="hljs-function"><span class="hljs-params">(path, value = <span class="hljs-literal">null</span>)</span>-&gt;</span>
    <span class="hljs-keyword">unless</span> Type(path, String)
      throwError(<span class="hljs-string">"Must use string as path accessor"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>unpack the path </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    parts = utils.splitPath(path)</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>if a value is passed this is a set    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> value  
      schema = <span class="hljs-property">@constructor</span>._schema.attribute(path)

      data = <span class="hljs-property">@_data</span>
      last = parts.pop()

      <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> parts
        data = data[part]

      data[last] = <span class="hljs-keyword">if</span> schema</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>if this attr’s schema is a model, use that 
model’s constructor which will in turn call 
cast. otherwise call cast directly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> Type(schema, Schema)
          <span class="hljs-keyword">new</span> schema.Model(value)
        <span class="hljs-keyword">else</span>
          schema.cast(value)
      <span class="hljs-keyword">else</span>
        value</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>otherwise it’s a get</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span>
      data = <span class="hljs-property">@_data</span>

      <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> parts
        data = data[part]

      <span class="hljs-keyword">return</span> data


<span class="hljs-built_in">module</span>.exports = DataModel</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
